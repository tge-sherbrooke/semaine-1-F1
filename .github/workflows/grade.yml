name: Formatif F1 - Auto-correction

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ Configuration Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          # Installer uniquement les dÃ©pendances de test
          # Les bibliothÃ¨ques Adafruit (adafruit-circuitpython-bmp, adafruit-blinka)
          # sont spÃ©cifiques au matÃ©riel Raspberry Pi et ne sont pas disponibles
          # pour Python standard. Les tests utilisent des mocks Ã  la place.
          pip install pytest pytest-mock

      - name: ðŸ” ExÃ©cution des tests
        id: tests
        run: |
          # Ajouter le rÃ©pertoire tests au PYTHONPATH pour les mocks CI
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/tests"
          python -m pytest tests/ -v --tb=short --color=yes
        continue-on-error: true

      - name: ðŸ“Š GÃ©nÃ©ration du rapport
        if: always()
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/tests"
          python -m pytest tests/ -v --tb=no --color=no | tee test_output.txt

      - name: ðŸ’¬ Commentaire sur le PR (si applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = '';
            try {
              output = fs.readFileSync('test_output.txt', 'utf8');
            } catch(e) {
              output = 'Tests exÃ©cutÃ©s. Consultez les logs pour les dÃ©tails.';
            }

            const feedback = `
            ## ðŸ¤– RÃ©sultats de l'auto-correction - Formatif F1

            **Note**: Ceci est une Ã©valuation **formative** et **non notÃ©e**.
            Son but est de vous donner une rÃ©troaction rapide!

            ### ðŸ“‹ RÃ©sultats des tests

            ```
            ${output}
            ```

            ### ðŸ’¡ Prochaines Ã©tapes

            - âœ… Si tous les tests passent: Excellent travail!
            - âš ï¸ Si des tests Ã©chouent: Lisez les messages d'erreur et corrigez
            - ðŸ“š Consultez le guide de dÃ©pannage si nÃ©cessaire

            N'hÃ©sitez pas Ã  demander de l'aide Ã  l'enseignant!
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: feedback
            });

      - name: ðŸ“ Upload des rÃ©sultats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_output.txt

      - name: âœ… Statut du workflow
        if: always()
        run: |
          echo "## ðŸ“Š RÃ©sumÃ© de l'Ã©valuation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatif F1** - Introduction au Raspberry Pi et BMP280" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Indicateurs Ã©valuÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- **IND-00SX-E**: ExÃ©cution â€” Environnement & DÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "- **IND-00SX-D**: Conception â€” Programmation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consultez l'onglet 'Actions' pour les dÃ©tails des tests." >> $GITHUB_STEP_SUMMARY
